<!doctype html>
{% load static %}
<html lang="it">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UrbanKnowledge ‚Äî Dashboard Azienda</title>

  <link rel="stylesheet" href="{% static 'style.css' %}" />
  <link rel="icon" type="image/png" href="{% static 'imgs/logo.png' %}">

  <style>
    /* =========================
       WIDE LAYOUT OVERRIDES (solo questa pagina)
       ========================= */
    .container {
      width: min(1400px, calc(100% - 32px));
      /* era 1120px: ora pi√π largo */
      margin: 0 auto;
    }

    /* allarga la sidebar rispetto al default (280px) */
    .app-body {
      grid-template-columns: 320px 1fr;
      /* sidebar pi√π larga */
    }

    /* editor 3 colonne pi√π ampie */
    .editor {
      grid-template-columns: 360px 1fr 440px;
      /* sx, centro, dx */
    }

    /* breakpoint un po' pi√π generoso */
    @media (max-width: 1200px) {
      .editor {
        grid-template-columns: 1fr;
      }

      .app-body {
        grid-template-columns: 1fr;
      }
    }

    /* Piccoli aggiustamenti locali (non toccano style.css) */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .tab-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.55);
      font-weight: 900;
    }

    .mini {
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
    }

    .pill-input {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: end;
    }

    .pill-input .field {
      flex: 1;
      min-width: 240px;
    }

    .pill-input .field label {
      display: block;
      font-size: 12px;
      font-weight: 900;
      margin: 0 0 6px;
    }

    .toast {
      display: none;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(59, 120, 64, 0.25);
      background: rgba(59, 120, 64, 0.12);
      color: var(--g4);gkgg,j
      font-weight: 900;
    }

    .toast.show {
      display: block;
    }

    .palazzi {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    @media (max-width: 900px) {
      .palazzi {
        grid-template-columns: 1fr;
      }
    }

    .palazzo-card {
      border-radius: 18px;
      border: 1px solid rgba(62, 49, 31, 0.18);
      background: rgba(255, 255, 255, 0.55);
      padding: 12px;
    }

    .palazzo-card header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .palazzo-card header strong {
      font-weight: 900;
    }

    .palazzo-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    @media (max-width: 520px) {
      .palazzo-grid {
        grid-template-columns: 1fr;
      }
    }

    .palazzo-grid label {
      display: block;
      font-size: 12px;
      font-weight: 900;
      margin: 0 0 6px;
    }

    .codebox {
      width: 100%;
      min-height: 180px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      line-height: 1.5;
    }

    /* ===== Editor tabs (3 tasti) ===== */
    .editor-tabs {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .editor-tab {
      cursor: pointer;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.55);
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 900;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }

    .editor-tab:hover {
      transform: translateY(-1px);
      border-color: rgba(59, 120, 64, 0.55);
    }

    .editor-tab.is-active {
      background: linear-gradient(135deg, rgba(59, 120, 64, 0.95), rgba(74, 103, 39, 0.95));
      border-color: rgba(34, 106, 37, 0.95);
      color: #fff;
    }

    /* Mobile/tablet: mostra 1 pannello alla volta */
    @media (max-width: 1200px) {
      .editor {
        grid-template-columns: 1fr;
        /* gi√† lo fai, qui ribadisco */
      }

      .editor-panel {
        display: none;
      }

      .editor-panel.is-active {
        display: block;
      }
    }

    .editor {
      grid-template-columns: 1fr !important;
    }

    /* Desktop: sempre visibili tutti i pannelli */
    @media (min-width: 1201px) {
      .editor-panel {
        display: block;
      }
    }
  </style>
</head>

<body>
  <!-- TOPBAR -->
  <header class="topbar">
    <div class="container topbar-inner">
      <a class="brand" href="{% url 'dashboard' %}" aria-label="Torna alla dashboard">
        <div class="logo" aria-hidden="true">
          <img src="{% static 'imgs/logo.png' %}" alt="Logo UrbanKnowledge">
        </div>
        <div>UrbanKnowledge</div>
      </a>

      <div class="topbar-right">
        <span class="badge success">Azienda</span>
        <div class="pill">{{ profile.company_name|default:"Azienda" }}</div>
        <a class="btn btn-ghost" href="{% url 'private_page' %}">Area privata</a>
        <form method="post" action="{% url 'logout' %}" style="display:inline;">
          {% csrf_token %}
          <button class="btn btn-outline" type="submit">Logout</button>
        </form>
        <a class="avatar-link" href="{% url 'private_profile' %}" title="Profilo">
          <div class="avatar-dot" aria-hidden="true"></div>
          <span class="sr-only">Apri profilo</span>
        </a>
      </div>
    </div>
  </header>

  <main class="app">
    <div class="container app-body">
      <!-- SIDEBAR (MENU) -->
      <aside class="card sidebar" aria-label="Menu azienda">
        <div class="panel-title">Pannello aziendale</div>
        <nav class="side-nav">
          <a class="side-link" href="#dipendenti" id="link-dipendenti">
            Dipendenti <span class="badge">{{ employee_emails|length|default:"0" }}</span>
          </a>
          <a class="side-link" href="#corsi" id="link-corsi">
            Corsi <span class="badge">0</span>
          </a>
          <a class="side-link" href="#editor" id="link-editor">
            Editor mappe <span class="badge">‚úé</span>
          </a>
        </nav>

        <hr class="sep" />

        <div class="help">
          <strong>Come funziona</strong><br>
          ‚Ä¢ Aggiungi le email dei dipendenti gi√† iscritti<br>
          ‚Ä¢ Le mappe (corsi) al momento sono 0 (statico)<br>
          ‚Ä¢ Nell‚Äôeditor scegli per ogni palazzo il tipo di domanda (bozza)
        </div>
      </aside>

      <!-- CONTENT -->
      <section class="card content">
        <div class="kpi" style="align-items:flex-start;">
          <div>
            <div class="kicker">üè¢ Dashboard Azienda</div>
            <h1 class="h2" style="margin-top:12px;">Gestione Dipendenti, Corsi e Mappe</h1>
            <p class="p">Questa pagina √® pensata per aziende: qui gestisci dipendenti, visualizzi i corsi e prepari una
              bozza di mappa (senza salvarla).</p>
          </div>
          <div style="text-align:right;">
            <span class="mini">Account</span><br>
            <span class="tab-pill">{{ user.username|default:"Admin" }}</span>
          </div>
        </div>

        {% if messages %}
        <div style="margin-top:12px; display:grid; gap:10px;">
          {% for message in messages %}
          <div class="card pad" style="box-shadow:none; background: rgba(255,255,255,0.66);">
            <strong>{{ message }}</strong>
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <hr class="sep" />

        <!-- 1) DIPENDENTI -->
        <section id="dipendenti" class="card pad" style="box-shadow:none; background: rgba(255,255,255,0.66);">
          <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:flex-end;">
            <div>
              <strong>Dipendenti</strong>
              <div class="help">Aggiungi le email dei dipendenti <b>gi√† iscritti</b> alla piattaforma.</div>
            </div>
            <span class="badge success">Gestione inviti (bozza)</span>
          </div>

          <form method="post" action="{% url 'company_add_employee' %}" style="margin-top:14px;">
            {% csrf_token %}
            <div class="pill-input">
              <div class="field">
                <label for="employee_email">Email dipendente</label>
                <input id="employee_email" name="email" type="email" required placeholder="nome.cognome@esempio.it"
                  autocomplete="email" />
                <div class="mini">Viene aggiunta solo se l‚Äôutente esiste gi√† ed √® un account dipendente.</div>
              </div>
              <button class="btn btn-primary" type="submit">Aggiungi</button>
            </div>
          </form>

          <div style="margin-top:14px;">
            <table class="table" aria-label="Elenco dipendenti">
              <thead>
                <tr>
                  <th>Email</th>
                  <th style="width: 160px;">Azioni</th>
                </tr>
              </thead>
              <tbody>
                {% for e in employee_emails %}
                <tr>
                  <td><strong>{{ e }}</strong></td>
                  <td>
                    <form method="post" action="{% url 'company_remove_employee' %}" style="display:inline;">
                      {% csrf_token %}
                      <input type="hidden" name="email" value="{{ e }}" />
                      <button class="btn btn-ghost" type="submit">Rimuovi</button>
                    </form>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="2">Nessun dipendente aggiunto. Inserisci un‚Äôemail qui sopra.</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </section>

        <hr class="sep" />

        <!-- 2) CORSI / MAPPE -->
        <section id="corsi" class="card pad" style="box-shadow:none; background: rgba(255,255,255,0.66);">
          <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:flex-end;">
            <div>
              <strong>Corsi</strong>
              <div class="help">I corsi corrispondono alle <b>mappe di gioco</b>. Al momento √® tutto statico.</div>
            </div>
            <span class="tab-pill">Mappe: <b>0</b></span>
          </div>

          <div style="margin-top:12px;" class="help">
            Nessuna mappa disponibile.
          </div>

          <div class="btn-row" style="margin-top:12px;">
            <a class="btn btn-primary" href="#editor">Apri editor mappe</a>
            <a class="btn btn-outline" href="#" onclick="return false;">Gestisci corsi (coming soon)</a>
          </div>
        </section>

        <hr class="sep" />

        <!-- 3) EDITOR MAPPE (BOZZA) -->
        <!-- 3) EDITOR MAPPE (BOZZA) -->
        <section id="editor" class="card pad" style="box-shadow:none; background: rgba(255,255,255,0.66);">
          <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:flex-end;">
            <div>
              <strong>Editor mappe (bozza)</strong>
              <div class="help">
                Una mappa √® un gioco arcade: il giocatore risolve problemi in ogni <b>palazzo</b>.
                Qui scegli che tipo di domanda mettere in ogni palazzo (riempi il buco, riscrivi da 0, ecc.).
              </div>
            </div>
            <span class="badge warn">Non salva e non crea nulla</span>
          </div>

          <!-- ‚úÖ TAB BUTTONS -->
          <div class="editor-tabs" role="tablist" aria-label="Sezioni editor mappe">
            <button type="button" class="editor-tab is-active" data-editor-tab="settings" aria-selected="true">
              Impostazioni mappa
            </button>
            <button type="button" class="editor-tab" data-editor-tab="preview" aria-selected="false">
              Anteprima mappa
            </button>
            <button type="button" class="editor-tab" data-editor-tab="choices" aria-selected="false">
              Scelte per palazzo
            </button>
          </div>

          <div class="editor" style="margin-top:14px;">
            <!-- Colonna sinistra: impostazioni -->
            <div class="card pad editor-panel is-active" data-editor-panel="settings" id="editor-settings"
              style="box-shadow:none; background: rgba(255,255,255,0.62);">
              <div class="panel-title">Impostazioni mappa</div>
              <div class="field" style="margin-bottom:10px;">
                <label for="mapName">Nome mappa</label>
                <input id="mapName" type="text" placeholder="Es. Onboarding Matematica" />
              </div>
              <div class="field" style="margin-bottom:10px;">
                <label for="mapTheme">Tema</label>
                <select id="mapTheme">
                  <option value="city">Citt√†</option>
                  <option value="factory">Fabbrica</option>
                  <option value="office">Uffici</option>
                </select>
              </div>
              <div class="field" style="margin-bottom:10px;">
                <label for="palazziCount">Numero palazzi</label>
                <select id="palazziCount">
                  <option value="3">3</option>
                  <option value="4" selected>4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                </select>
                <div class="mini">Genera i palazzi e le relative scelte.</div>
              </div>

              <div class="btn-row" style="margin-top:12px;">
                <button class="btn btn-outline" type="button" id="btn-genera">Genera palazzi</button>
                <button class="btn btn-primary" type="button" id="btn-bozza">Crea bozza</button>
              </div>

              <div id="toast" class="toast" role="status" aria-live="polite" style="margin-top:12px;"></div>

              <hr class="sep" />
              <div class="help">
                Suggerimento: usa la bozza come base per poi salvare su DB/API in futuro.
              </div>
            </div>

            <!-- Centro: canvas / preview -->
            <div class="card pad editor-panel" data-editor-panel="preview" id="editor-preview"
              style="box-shadow:none; background: rgba(255,255,255,0.62);">
              <div style="display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;">
                <div>
                  <div class="panel-title" style="margin:0;">Anteprima mappa</div>
                  <div class="help">Palazzi posizionati in modo semplice (solo preview)</div>
                </div>
                <span class="mini" id="previewHint">Premi ‚ÄúGenera palazzi‚Äù.</span>
              </div>

              <div class="canvas" id="canvas" aria-label="Anteprima mappa" style="margin-top:12px;"></div>
            </div>

            <!-- Destra: configurazione palazzi + JSON -->
            <div class="card pad editor-panel" data-editor-panel="choices" id="editor-choices"
              style="box-shadow:none; background: rgba(255,255,255,0.62);">
              <div class="panel-title">Scelte per palazzo</div>
              <div class="help">Queste opzioni sono modulari: scegli il tipo di domanda e qualche dettaglio.</div>

              <div id="palazzi" class="palazzi" style="margin-top:12px;"></div>

              <hr class="sep" />

              <div class="panel-title" style="margin-bottom:8px;">Bozza (JSON)</div>
              <textarea id="output" class="codebox" readonly aria-label="Output bozza JSON"
                placeholder="Qui comparir√† una bozza JSON..."></textarea>
              <div class="mini" style="margin-top:8px;">
                Nota: il pulsante ‚ÄúCrea bozza‚Äù <b>non salva</b>. Serve solo per mostrarti che struttura verrebbe
                generata.
              </div>
            </div>
          </div>
        </section>

      </section>
    </div>
  </main>

  <script>
    (function () {
      const $ = (id) => document.getElementById(id);
      const toast = $('toast');
      const canvas = $('canvas');
      const palazziWrap = $('palazzi');
      const output = $('output');
      const hint = $('previewHint');

      const TYPES = [
        { value: 'fill_gap', label: 'Riempi il buco' },
        { value: 'rewrite', label: 'Riscrivi da 0' },
        { value: 'multiple', label: 'Scelta multipla' },
        { value: 'true_false', label: 'Vero/Falso' },
        { value: 'short', label: 'Risposta breve' },
      ];
      const SUBJECTS = [
        { value: 'math', label: 'Matematica' },
        { value: 'it', label: 'Informatica' },
        { value: 'econ', label: 'Economia' },
        { value: 'lang', label: 'Lingue' },
      ];

      function showToast(msg) {
        toast.textContent = msg;
        toast.classList.add('show');
        window.clearTimeout(showToast._t);
        showToast._t = window.setTimeout(() => toast.classList.remove('show'), 2400);
      }

      function makeSelect(options, value) {
        const sel = document.createElement('select');
        for (const o of options) {
          const opt = document.createElement('option');
          opt.value = o.value;
          opt.textContent = o.label;
          if (o.value === value) opt.selected = true;
          sel.appendChild(opt);
        }
        return sel;
      }

      function clear(node) { while (node.firstChild) node.removeChild(node.firstChild); }

      function generatePalazzi() {
        const n = parseInt($('palazziCount').value, 10);
        clear(palazziWrap);
        clear(canvas);

        for (let i = 1; i <= n; i++) {
          const card = document.createElement('div');
          card.className = 'palazzo-card';
          card.dataset.index = String(i);

          const header = document.createElement('header');
          const title = document.createElement('strong');
          title.textContent = `Palazzo ${i}`;
          const badge = document.createElement('span');
          badge.className = 'badge';
          badge.textContent = 'Quest';
          header.appendChild(title);
          header.appendChild(badge);

          const grid = document.createElement('div');
          grid.className = 'palazzo-grid';

          const f1 = document.createElement('div');
          const l1 = document.createElement('label');
          l1.textContent = 'Tipo domanda';
          const s1 = makeSelect(TYPES, TYPES[(i - 1) % TYPES.length].value);
          s1.name = `p${i}_type`;
          f1.appendChild(l1);
          f1.appendChild(s1);

          const f2 = document.createElement('div');
          const l2 = document.createElement('label');
          l2.textContent = 'Materia';
          const s2 = makeSelect(SUBJECTS, SUBJECTS[(i - 1) % SUBJECTS.length].value);
          s2.name = `p${i}_subject`;
          f2.appendChild(l2);
          f2.appendChild(s2);

          const f3 = document.createElement('div');
          const l3 = document.createElement('label');
          l3.textContent = 'Difficolt√†';
          const s3 = makeSelect([
            { value: 'easy', label: 'Facile' },
            { value: 'medium', label: 'Media' },
            { value: 'hard', label: 'Difficile' },
          ], 'medium');
          s3.name = `p${i}_difficulty`;
          f3.appendChild(l3);
          f3.appendChild(s3);

          const f4 = document.createElement('div');
          const l4 = document.createElement('label');
          l4.textContent = 'Moduli (bozza)';
          const s4 = makeSelect([
            { value: 'core', label: 'Core' },
            { value: 'timed', label: 'A tempo' },
            { value: 'hint', label: 'Con suggerimenti' },
          ], 'core');
          s4.name = `p${i}_module`;
          f4.appendChild(l4);
          f4.appendChild(s4);

          grid.appendChild(f1);
          grid.appendChild(f2);
          grid.appendChild(f3);
          grid.appendChild(f4);

          card.appendChild(header);
          card.appendChild(grid);
          palazziWrap.appendChild(card);
        }

        const cols = Math.min(3, Math.max(2, Math.ceil(n / 2)));
        const gap = 18;
        const blockW = 140;
        const blockH = 92;

        for (let i = 1; i <= n; i++) {
          const b = document.createElement('div');
          b.className = 'block';
          b.setAttribute('role', 'group');
          b.setAttribute('aria-label', `Palazzo ${i}`);
          b.innerHTML = `Palazzo ${i}<em>Configura a destra</em>`;

          const r = Math.floor((i - 1) / cols);
          const c = (i - 1) % cols;
          b.style.left = `${gap + c * (blockW + gap)}px`;
          b.style.top = `${gap + r * (blockH + gap)}px`;
          canvas.appendChild(b);
        }

        hint.textContent = `Palazzi generati: ${n}`;
        showToast('Palazzi generati (solo preview).');
      }
      function collectDraft() {
        const n = palazziWrap.children.length;
        const mapName = $('mapName').value || 'Nuova mappa';
        const theme = $('mapTheme').value;

        const palazzi = [];
        for (const card of palazziWrap.children) {
          const i = parseInt(card.dataset.index, 10);
          const type = card.querySelector(`select[name="p${i}_type"]`)?.value || 'fill_gap';
          const subject = card.querySelector(`select[name="p${i}_subject"]`)?.value || 'math';
          const difficulty = card.querySelector(`select[name="p${i}_difficulty"]`)?.value || 'medium';
          const module = card.querySelector(`select[name="p${i}_module"]`)?.value || 'core';
          palazzi.push({ index: i, question_type: type, subject, difficulty, module });
        }

        return {
          name: mapName,
          theme,
          buildings_count: n,
          buildings: palazzi,
          note: 'BOZZA: non salvata. Serve solo per UI.'
        };
      }

      const links = [
        { id: 'dipendenti', link: $('link-dipendenti') },
        { id: 'corsi', link: $('link-corsi') },
        { id: 'editor', link: $('link-editor') },
      ];
      function setActive(sectionId) {
        for (const l of links) {
          if (!l.link) continue;
          l.link.classList.toggle('active', l.id === sectionId);
        }
      }
      function onScroll() {
        const y = window.scrollY;
        let current = 'dipendenti';
        for (const l of links) {
          const el = document.getElementById(l.id);
          if (!el) continue;
          const top = el.getBoundingClientRect().top + window.scrollY;
          if (y + 140 >= top) current = l.id;
        }
        setActive(current);
      }
      window.addEventListener('scroll', onScroll, { passive: true });

      $('btn-genera').addEventListener('click', () => {
        output.value = '';
        generatePalazzi();
      });

      $('btn-bozza').addEventListener('click', () => {
        if (palazziWrap.children.length === 0) generatePalazzi();
        const draft = collectDraft();
        output.value = JSON.stringify(draft, null, 2);
        showToast('Bozza creata ‚úÖ (non salvata)');
      });

      try { generatePalazzi(); } catch (e) { }
      onScroll();
    })();

    // ===== Tabs editor (settings / preview / choices) =====
    const tabButtons = document.querySelectorAll('[data-editor-tab]');
    const tabPanels = document.querySelectorAll('[data-editor-panel]');

    function activateEditorTab(key) {
      tabButtons.forEach(b => {
        const active = b.getAttribute('data-editor-tab') === key;
        b.classList.toggle('is-active', active);
        b.setAttribute('aria-selected', active ? 'true' : 'false');
      });

      tabPanels.forEach(p => {
        const active = p.getAttribute('data-editor-panel') === key;
        p.classList.toggle('is-active', active);
      });

      const panel = document.querySelector(`[data-editor-panel="${key}"]`);
      if (panel) panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    tabButtons.forEach(b => {
      b.addEventListener('click', () => {
        activateEditorTab(b.getAttribute('data-editor-tab'));
      });
    });

    activateEditorTab('settings'); // default


  </script>
</body>

</html>